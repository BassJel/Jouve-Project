<?xml version="1.0" encoding="UTF-8"?>
<project name="package_constellio" default="package_dist" basedir=".">

	<!-- ========================= PROPERTIES ============================= -->
	<property name="constellio.version" value="3.0M3" />

		<!-- Define Directories. -->
	<property name="project.dir" value="." />
	<property name="packaging.dir" value="${project.dir}/packaging" />
	<property name="build.dir" value="${project.dir}/build" />
	<property name="dist.dir" value="${project.dir}/dist" />
	<property name="izpack.jar.dir" value="${project.dir}/izpackResource/jar" />

	<property name="izpack.resource" value="${project.dir}/izpackResource" />
	<property name="izpack.resource.constellio" value="${izpack.resource}/constellio" />
	<property name="izpack.classes.dir" value="${project.dir}/izpackResource/classes" />
	
	<property name="build.classes.dir" value="${build.dir}/classes" />
	<property name="build.standalone.dir" value="${build.dir}/packaging" />
	<property name="dist.standalone.file" value="${dist.dir}/constellio_standalone_${constellio.version}.zip" />
	<property name="webapps.dir" value="${build.standalone.dir}/tomcat/webapps" />

	<target name="buildinfo">
	    <tstamp>
	        <format property="builtat" pattern="MM/dd/yyyy hh:mm aa" timezone="America/New_York"/>
	    </tstamp>        
	    <exec executable="whoami" outputproperty="whoami"/>

	    <propertyfile file="${project.dir}/source/java/project.properties"
	        comment="This file is automatically generated - DO NOT EDIT">        
	        <entry key="buildtime" value="${builtat}"/>
	        <entry key="builder" value="${whoami}"/>
	        <entry key="version" value="${constellio.version}"/>
	        <entry key="ant.version" value="${ant.version}"/>
	    	<entry key="java.version" value="${ant.java.version}"/>
	    </propertyfile>
	</target>
	
	
	<path id="project.class.path">
		<fileset dir="${project.dir}/WebContent/WEB-INF/lib/">
			<include name="*.jar" />
		</fileset>
		<pathelement path="${project.dir}/bin/" />
	</path>

	<path id="izpack.class.path">
		<fileset dir="${izpack.jar.dir}/">
			<include name="*.jar" />
		</fileset>
		<pathelement path="${project.dir}/bin/" />
	</path>

	<target name="compile">
		<mkdir dir="${build.classes.dir}" />
		<copy todir="${build.classes.dir}">
		    <fileset dir="${project.dir}/source/java" />
		</copy>
		<javac destdir="${build.classes.dir}" optimize="on" verbose="off" source="1.7" target="1.7">
			<classpath refid="project.class.path" />
			<src path="${project.dir}/source/java" />
		</javac>
	</target>

	<target name="copy_packaging_files">
		<delete dir="${build.standalone.dir}" />
		<mkdir dir="${build.standalone.dir}" />
		<copy todir="${build.standalone.dir}">
			<fileset dir="${packaging.dir}/">
				<include name="**" />
			</fileset>
		</copy>
		<copy file="README" todir="${build.standalone.dir}"/>
		<copy file="COPYING" todir="${build.standalone.dir}"/>
	</target>

	<target name="makewar" depends="buildinfo,compile,copy_packaging_files">
		<war destfile="${webapps.dir}/constellio.war" webxml="${project.dir}/WebContent/WEB-INF/web.xml">
			<fileset dir="${project.dir}/WebContent" />

			<classes dir="${build.classes.dir}" />
		</war>
		<delete dir="${build.classes.dir}" />
	</target>
	
	<target name="package_dist" depends="makewar">
		<mkdir dir="${dist.dir}" />
		<delete file="${dist.standalone.file}" />
		<zip destfile="${dist.standalone.file}" basedir="${build.standalone.dir}" />
		<delete dir="${build.standalone.dir}" />
	</target>
			
	<target name="unwar" depends="makewar">
		<unzip src="${webapps.dir}/constellio.war" dest="${webapps.dir}/constellio"/>
		<delete file="${webapps.dir}/constellio.war" />
	</target>

	<target name="copybeforeinstall" depends="unwar">
		<delete dir="${izpack.resource.constellio}" />
		<mkdir dir="${izpack.resource.constellio}" />
		  <copy todir="${izpack.resource.constellio}">
		    <fileset dir="${build.standalone.dir}"/>
		  </copy>
		<delete dir="${build.standalone.dir}" />
	</target>

	<target name="compileIzPack">
		<mkdir dir="${izpack.classes.dir}" />
		<copy todir="${izpack.classes.dir}">
		    <fileset dir="${project.dir}/source/izpack" />
		</copy>
		<javac destdir="${izpack.classes.dir}" optimize="on" verbose="off" source="1.7" target="1.7">
			<classpath refid="izpack.class.path" />
			<src path="${project.dir}/source/izpack" />
		</javac>
	</target>

   	<target name="jarIzPack" depends="compileIzPack">
    	<jar jarfile="${izpack.jar.dir}/constellio-izpack.jar">
    		<fileset dir="${izpack.classes.dir}">
            	<include name="**/*.class"/>
			</fileset>
       </jar>
      <delete dir="${izpack.classes.dir}" />
   	</target>

	<target name="package_installer" depends="copybeforeinstall,jarIzPack">
		<mkdir dir="${dist.dir}" />
	 	<delete file="${dist.dir}/constellio_install_${constellio.version}.jar"/>
		<taskdef name="izpack" classpath="${izpack.resource}/jar/standalone-compiler.jar" classname="com.izforge.izpack.ant.IzPackTask" />
		<echo message="Running IzPack to build the installer..." />
		<izpack input="${izpack.resource}/constellio_install.xml"
			output="${dist.dir}/constellio_install_${constellio.version}.jar" 
			installerType="standard" basedir="${izpack.resource}" />
	 	<delete dir="${izpack.resource.constellio}" />
		<echo message="Done." />
	</target>
</project>
